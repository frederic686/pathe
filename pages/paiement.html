<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Paiement sécurisé – Pathé</title>
  <link rel="stylesheet" href="../assets/css/paiement.css">
</head>

<body>

  <main>
    <div class="row">
      <div class="container">
        <div class="layout">

               <aside class="left">
                        <nav class="breadcrumb" aria-label="Fil d’Ariane">
                            <a href="../index.html">Accueil
                                <img src="../assets/images/PICTOS/fleche.png" alt="→" class="icon-fleche" />
                            </a>
                            <a href="./catalogue.html">Choisir une séance
                                <img src="../assets/images/PICTOS/fleche.png" alt="→" class="icon-fleche" />
                            </a>
                            <span class="current">Vos places</span>
                        </nav>

                        <div class="left-content">
                            <img class="logo-pathe" src="../assets/images/PICTOS/logo-international-white 1.png"
                                alt="Pathé" />
                            <img id="filmPoster" class="poster" src="" alt="Affiche du film" />

                            <div class="movie-info">
                                <h1 id="movieTitle" class="title">Titre du film</h1>
                                <p id="movieInfo" class="sub"></p>
                            </div>

                            <div class="seance-info">
                                <div class="time-block">
                                    <span id="seanceTime" class="time">15:00</span>
                                    <span id="version" class="version">VOSTFR</span>
                                </div>
                                <p id="seanceEnd" class="end">Fin de la séance à 17:35</p>
                            </div>
                        </div>
                    </aside>

          <section class="right">

                        <header class="topbar">
                            <div class="salle">
                                Salle <span id="roomNo">–</span>
                                <img src="../assets/images/PICTOS/desactive-black.png" alt="" class="desactive">
                            </div>
                            <button class="btn-compte" type="button" onclick="history.back()">
                                <img src="../assets/images/PICTOS/fleche.png" alt="←" class="icon-fleche rotate" />
                                Retour
                            </button>
                        </header>


            <h1 class="title">Paiement sécurisé</h1>

            <section class="card" aria-label="Choisir mon mode de paiement">
              <div class="accordion" id="payMethods">

                <article class="ac-item open" data-method="card">
                  <button class="ac-head" aria-expanded="true">
                    <span class="title">Carte bancaire</span>
                    <span class="logos" aria-hidden="true">
                      <img class="logo" src="../assets/images/LOGO/cb.png" alt="Carte Bancaire">
                      <img class="logo" src="../assets/images/LOGO/visa.webp" alt="Visa">
                      <img class="logo" src="../assets/images/LOGO/mastercard.png" alt="Mastercard">
                      <img class="logo" src="../assets/images/LOGO/amex.jpg" alt="American Express">
                    </span>
                  </button>
                  <div class="ac-body" role="region" aria-label="Formulaire carte bancaire">
                    <div class="ac-content">
                      <div class="input">
                        <label for="cc-number">Numéro de carte</label>
                        <input id="cc-number" inputmode="numeric" autocomplete="cc-number"
                          placeholder="1234 5678 9012 3456" aria-describedby="cc-hint">
                        <div id="cc-hint" class="inline-help">Nous acceptons CB, Visa, Mastercard et Amex.</div>
                      </div>

                      <div class="grid-2" style="margin-top:10px">
                        <div class="input">
                          <label for="cc-exp">Date d’expiration</label>
                          <input id="cc-exp" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/AA">
                        </div>
                        <div class="input">
                          <label for="cc-cvc">Cryptogramme</label>
                          <input id="cc-cvc" inputmode="numeric" autocomplete="cc-csc" placeholder="CVC">
                        </div>
                      </div>

                      <div class="brand-row" id="brandRow" aria-live="polite"></div>
                      <div class="note">Le débit est effectué uniquement après validation de votre commande.</div>
                    </div>
                  </div>
                </article>

                <article class="ac-item" data-method="gpay">
                  <button class="ac-head" aria-expanded="false">
                    <span class="title">Google Pay</span>
                    <span class="logos" aria-hidden="true">
                      <img class="logo lg" src="../assets/images/LOGO/gpay.png" alt="Google Pay">
                    </span>
                  </button>
                  <div class="ac-body" role="region" aria-label="Payer avec Google Pay">
                    <div class="ac-content">
                      <button class="pay-btn" id="btnGpay" aria-label="Payer avec Google Pay">
                        <img class="logo lg" src="../assets/images/LOGO/gpay.png" alt="Google Pay">
                        Continuer avec Google&nbsp;Pay
                      </button>
                      <div class="note">Redirection simulée vers Google Pay dans ce prototype.</div>
                    </div>
                  </div>
                </article>
              </div>
            </section>

            <div class="stickybar">
              <div class="paybar">
                <div class="total">
                  <small>Total à régler</small>
                  <span id="totalAmount">30,30 €</span>
                </div>
                <div class="cta">
                  <button class="btn-ghost" type="button" onclick="history.back()">Retour</button>
                  <button class="btn-primary btn-arrow" id="btnContinue" type="button">
                    Continuer <span aria-hidden="true">➜</span>
                  </button>
                </div>
              </div>
            </div>

            <p class="note" style="text-align:center;margin:14px 0 0">
              Astuce : utilisez <kbd>TAB</kbd> et <kbd>ESPACE</kbd> pour ouvrir/fermer les sections.
            </p>

          </section></div>
      </div>
    </div>
  </main>
  <script>

/* =========================================================
   ticket.js – Récup params & hydratation du ticket
   Attendu dans l'URL : film, poster, salle, seance, langue, fin, seats, total
   ========================================================= */
(() => {
    const $ = (s, ctx = document) => ctx.querySelector(s);
    const $$ = (s, ctx = document) => [...ctx.querySelectorAll(s)];
    const fmtEUR = n => n.toLocaleString('fr-FR', {
        style: 'currency',
        currency: 'EUR'
    });

    // ====== Récup params pour la colonne gauche + total
    const qp = new URLSearchParams(location.search);
    const film = qp.get('film') || 'Titre du film';
    const posterParam = qp.get('poster') || '../assets/images/affiches/placeholder.jpg';
    const salle = qp.get('salle') || '—';
    const heure = qp.get('seance') || '--:--';
    const langue = qp.get('langue') || '—';
    const fin = qp.get('fin') || '—:—';
    const total = Number(qp.get('total')) || 30.30;
    // 👇 NEW : sièges (compat "places")
    const seats = qp.get('seats') || qp.get('places') || '';

    // Mise à jour de l'affichage du total à partir du paramètre URL
    document.getElementById('totalAmount').textContent = fmtEUR(total);

    // ---------------------------------------------------------
    // [COMMUN] Fonction d'hydratation de la colonne gauche
    // ---------------------------------------------------------
    async function hydrateLeftColumn(params) {
        const poster = params.get('poster') || '';
        const film = params.get('film') || 'Film';
        const salle = params.get('salle') || '—';
        const seance = params.get('seance') || '';
        const langue = params.get('langue') || '—';
        const endQP = params.get('end') || '';
        const leftPane = document.querySelector('.left');
        const posterEl = document.querySelector('#filmPoster');
        const titleEl = document.querySelector('#movieTitle');
        const seanceTimeEl = document.querySelector('#seanceTime');
        const seanceEndEl = document.querySelector('#seanceEnd');
        const seanceLangEl = document.querySelector('#version');
        const roomNoEl = document.querySelector('#roomBadge');

        // Mise à jour de l'affiche et du fond de la colonne gauche
       const posterFile = (poster ? poster.split('/').pop() : '') || 'placeholder.jpg';
        if (posterEl) {
            posterEl.src = `../assets/images/FILMS/${posterFile}`;
            posterEl.alt = `Affiche : ${film}`;
        }
        if (leftPane) {
            leftPane.style.setProperty('--left-bg', `url("../images/FILMS/${posterFile}")`);
        }

        // Mise à jour des textes
        if (titleEl) titleEl.textContent = film;
        if (roomNoEl) roomNoEl.textContent = `Salle ${salle}`;
        if (seanceTimeEl) seanceTimeEl.textContent = seance || '—:—';
        if (seanceLangEl) seanceLangEl.textContent = langue || '—';
        
        // Gestion de l'heure de fin (fin prévue)
        if (seanceEndEl) {
            if (endQP) {
                seanceEndEl.textContent = `Fin prévue à ${endQP}`;
            } else {
                try {
                    const res = await fetch('../data/films.json');
                    const list = await res.json();
                    const f = list.find(x => x.titre === film);
                    const s = f?.séances?.find(x => String(x.salle) === String(salle) && x.horaire === seance);
                    seanceEndEl.textContent = s?.fin ? `Fin prévue à ${s.fin}` : 'Fin prévue —:—';
                } catch (error) {
                    console.error("Erreur lors de la récupération de la fin de séance", error);
                    seanceEndEl.textContent = 'Fin prévue —:—';
                }
            }
        }
    }
    
    // Appel de la fonction harmonisée
    hydrateLeftColumn(qp);

    // ====== Accordéon
    const items = $$('#payMethods .ac-item');
    items.forEach(item => {
        const head = $('.ac-head', item);
        const body = $('.ac-body', item);
        const openOne = () => {
            items.forEach(i => {
                const h = $('.ac-head', i),
                    b = $('.ac-body', i);
                const on = i === item;
                i.classList.toggle('open', on);
                h.setAttribute('aria-expanded', String(on));
                b.style.maxHeight = on ? (b.scrollHeight + 'px') : '0px';
            });
        };
        if (item.classList.contains('open')) body.style.maxHeight = body.scrollHeight + 'px';
        head.addEventListener('click', openOne);
        head.addEventListener('keydown', e => {
            if (e.key === ' ' || e.key === 'Enter') {
                e.preventDefault();
                openOne();
            }
        });
    });

    // ====== Masques + détection marque carte (16 chiffres, pas de Luhn)
    const numberInput = $('#cc-number');
    const expInput = $('#cc-exp');
    const cvcInput = $('#cc-cvc');
    const brandRow = $('#brandRow');

    numberInput?.addEventListener('input', (e) => {
        // garde uniquement les chiffres et limite à 16
        let v = e.target.value.replace(/\D/g, '').slice(0, 16);

        // format par groupe de 4
        e.target.value = v.replace(/(.{4})/g, '$1 ').trim();

        // détection simple de la marque
        let brand = 'cb';
        if (/^4/.test(v)) brand = 'visa';
        else if (/^(5[1-5]|2[2-7])/.test(v)) brand = 'mc';
        else if (/^3[47]/.test(v)) brand = 'amex'; // sera refusé au "Continuer" si != 16

        const logos = {
            cb: '../assets/images/LOGO/cb.png',
            visa: '../assets/images/LOGO/visa.webp',
            mc: '../assets/images/LOGO/mastercard.png',
            amex: '../assets/images/LOGO/amex.jpg'
        };
        brandRow.innerHTML = v ? `<img class="logo" src="${logos[brand]}" alt="${brand.toUpperCase()}">` : '';

        // feedback visuel : vert uniquement à 16 chiffres, jamais de rouge ici
        e.target.classList.remove('valid', 'invalid');
        if (v.length === 16) e.target.classList.add('valid');
    });

    expInput?.addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 4);
        if (v.length >= 3) v = v.slice(0, 2) + '/' + v.slice(2);
        e.target.value = v;
        e.target.classList.remove('valid', 'invalid');
        if (v.length === 5) e.target.classList.add(validExpiry(v) ? 'valid' : 'invalid');
    });

    cvcInput?.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
        e.target.classList.remove('valid', 'invalid');
        if (e.target.value.length >= 3) e.target.classList.add('valid');
    });

    function validExpiry(mmYY) {
        const [mm, yy] = mmYY.split('/').map(n => parseInt(n, 10));
        if (!mm || mm < 1 || mm > 12) return false;
        const now = new Date(),
            y = 2000 + yy,
            m = mm - 1;
        const exp = new Date(y, m + 1, 1);
        return exp > now;
    }

    // 👇 NEW : redirection vers ticket.html avec TOUTES les infos
    function goToTicket() {
        const params = new URLSearchParams({
            film,
            poster: posterParam,
            salle,
            seance: heure,
            langue,
            fin,
            seats,
            total: total.toFixed(2)
        });
        location.href = './ticket.html?' + params.toString();
    }

    // Démo boutons
    $('#btnGpay')?.addEventListener('click', () => goToTicket());

    $('#btnContinue').addEventListener('click', () => {
        const active = document.querySelector('.ac-item.open')?.dataset.method;
        if (active === 'card') {
            const raw = numberInput.value.replace(/\s+/g, ''); // chiffres seuls

            // Exiger exactement 16 chiffres
            if (raw.length !== 16) {
                numberInput.classList.remove('valid');
                numberInput.classList.add('invalid'); // rouge seulement au submit si ce n'est pas 16
                numberInput.focus();
                return;
            }

            if (!validExpiry(expInput.value)) {
                expInput.classList.add('invalid');
                expInput.focus();
                return;
            }
            if (cvcInput.value.length < 3) {
                cvcInput.classList.add('invalid');
                cvcInput.focus();
                return;
            }

            // ✅ Paiement carte OK (démo) -> ticket
            goToTicket();
        } else if (active === 'gpay') {
            // ✅ Google Pay sélectionné (démo) -> ticket
            goToTicket();
        } else {
            // ✅ fallback
            goToTicket();
        }
    });
})();
  </script>
</body>

</html>